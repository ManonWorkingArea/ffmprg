<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการการแปลงวิดีโอ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .task-card { transition: all 0.2s ease; }
        .task-card:hover { transform: translateY(-1px); }
    </style>
</head>
<body class="bg-white">
    <div id="app">
        <!-- แจ้งเตือน -->
        <div v-if="showNotification"
             class="fixed top-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-md text-sm z-50">
            {{ notificationMessage }}
        </div>

        <!-- แสดง API Errors -->
        <div v-if="Object.values(apiErrors).some(error => error)"
             class="fixed top-16 right-4 bg-red-500 text-white px-4 py-2 rounded-md text-sm z-40">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            มีปัญหาการเชื่อมต่อ API
        </div>

        <div class="min-h-screen py-6 px-4">
            <div class="max-w-5xl mx-auto">
                <!-- ส่วนหัว -->
                <div class="mb-8">
                    <h1 class="text-2xl font-medium text-gray-900">ระบบจัดการการแปลงวิดีโอ</h1>
                    <p class="text-sm text-gray-500 mt-1">จัดการและติดตามสถานะการแปลงวิดีโอของคุณ</p>
                </div>
                
                <!-- การ์ดแสดงสถิติ -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                    <div class="border rounded-lg p-4">
                        <p class="text-sm text-gray-500">งานทั้งหมด</p>
                        <p class="text-2xl font-medium mt-1">{{ stats.total }}</p>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <p class="text-sm text-gray-500">กำลังประมวลผล</p>
                        <p class="text-2xl font-medium mt-1 text-blue-600">{{ stats.processing }}</p>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <p class="text-sm text-gray-500">เสร็จสมบูรณ์</p>
                        <p class="text-2xl font-medium mt-1 text-green-600">{{ stats.completed }}</p>
                    </div>
                    
                    <div class="border rounded-lg p-4">
                        <p class="text-sm text-gray-500">ผิดพลาด</p>
                        <p class="text-2xl font-medium mt-1 text-red-600">{{ stats.error }}</p>
                    </div>

                    <div class="border rounded-lg p-4">
                        <p class="text-sm text-gray-500">ประหยัดพื้นที่</p>
                        <p class="text-lg font-medium mt-1 text-green-600">{{ stats.totalSaved }}</p>
                        <p class="text-xs text-gray-400">{{ stats.compressionRatio }}%</p>
                    </div>
                </div>

                <!-- เพิ่ม data ใน Vue app -->
                <div class="mb-8">
                    <h2 class="text-lg font-medium mb-4">สถานะระบบ</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- CPU Usage -->
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">CPU</span>
                                <span class="text-sm font-medium">{{ systemMetrics.cpu.cores }} Cores</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mb-1">
                                <div class="bg-blue-500 h-1.5 rounded-full transition-all" 
                                     :style="{ width: systemMetrics.cpu.usage + '%' }"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Usage</span>
                                <span>{{ Math.round(systemMetrics.cpu.usage) }}%</span>
                            </div>
                        </div>

                        <!-- Memory Usage -->
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">Memory</span>
                                <span class="text-sm font-medium">{{ Math.round(systemMetrics.memory.total) }} MB</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mb-1">
                                <div class="bg-green-500 h-1.5 rounded-full transition-all" 
                                     :style="{ width: systemMetrics.memory.usagePercent + '%' }"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Used: {{ Math.round(systemMetrics.memory.used) }} MB</span>
                                <span>{{ Math.round(systemMetrics.memory.usagePercent) }}%</span>
                            </div>
                        </div>

                        <!-- Disk Usage -->
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">Disk</span>
                                <span class="text-sm font-medium">{{ Math.round(systemMetrics.disk.total) }} GB</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5 mb-1">
                                <div class="bg-yellow-500 h-1.5 rounded-full transition-all" 
                                     :style="{ width: systemMetrics.disk.usagePercent + '%' }"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>Used: {{ Math.round(systemMetrics.disk.used) }} GB</span>
                                <span>{{ Math.round(systemMetrics.disk.usagePercent) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- เพิ่มสถานะ Job Queue -->
                <div class="mb-8">
                    <h2 class="text-lg font-medium mb-4">สถานะคิวงาน</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">งานที่กำลังทำ</span>
                                <i class="fas fa-cogs text-blue-500"></i>
                            </div>
                            <div class="text-lg font-medium">
                                {{ systemStatus.system.concurrentJobs || 0 }} / {{ systemStatus.system.maxConcurrentJobs || 0 }}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">Active / Max</div>
                            
                            <!-- แสดงสถานะ system load -->
                            <div v-if="systemStatus.system.systemLoad" class="mt-2 pt-2 border-t">
                                <div class="text-xs" 
                                     :class="systemStatus.system.systemLoad.canProcess ? 'text-green-600' : 'text-red-600'">
                                    <i :class="systemStatus.system.systemLoad.canProcess ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
                                    {{ systemStatus.system.systemLoad.canProcess ? 'ระบบปกติ' : 'ระบบโหลดหนัก' }}
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    CPU: {{ Math.round(systemStatus.system.systemLoad.cpuUsage) }}%
                                    <span :class="systemStatus.system.systemLoad.cpuUsage > (systemStatus.system.systemLoad.thresholds?.cpu || 85) ? 'text-red-500' : 'text-gray-500'">
                                        (เกณฑ์: {{ systemStatus.system.systemLoad.thresholds?.cpu || 85 }}%)
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500">
                                    Mem: {{ Math.round(systemStatus.system.systemLoad.memoryUsage) }}%
                                    <span :class="systemStatus.system.systemLoad.memoryUsage > (systemStatus.system.systemLoad.thresholds?.memory || 80) ? 'text-red-500' : 'text-gray-500'">
                                        (เกณฑ์: {{ systemStatus.system.systemLoad.thresholds?.memory || 80 }}%)
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">รอคิว</span>
                                <i class="fas fa-clock text-yellow-500"></i>
                            </div>
                            <div class="text-lg font-medium">{{ systemStatus.tasks.queued || 0 }}</div>
                            <div class="text-xs text-gray-500 mt-1">Queued jobs</div>
                        </div>

                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">Process ทำงาน</span>
                                <i class="fas fa-microchip text-green-500"></i>
                            </div>
                            <div class="text-lg font-medium">{{ systemStatus.system.activeProcesses || 0 }}</div>
                            <div class="text-xs text-gray-500 mt-1">FFmpeg processes</div>
                        </div>

                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-gray-500">ผิดพลาด</span>
                                <i class="fas fa-exclamation-triangle text-red-500"></i>
                            </div>
                            <div class="text-lg font-medium">{{ systemStatus.tasks.error || 0 }}</div>
                            <div class="text-xs text-gray-500 mt-1">Error jobs</div>
                        </div>
                    </div>
                    
                    <!-- ปุ่มจัดการระบบ -->
                    <div class="mt-4 flex gap-2">
                        <button @click="retryFailedTasks" 
                                class="text-xs px-3 py-1.5 bg-blue-500 text-white rounded hover:bg-blue-600"
                                :disabled="systemStatus.tasks.error === 0">
                            <i class="fas fa-redo mr-1"></i>
                            Retry Failed Tasks ({{ systemStatus.tasks.error || 0 }})
                        </button>
                        
                        <button @click="cleanupOldTasks" 
                                class="text-xs px-3 py-1.5 bg-gray-500 text-white rounded hover:bg-gray-600">
                            <i class="fas fa-trash mr-1"></i>
                            Cleanup Old Tasks
                        </button>
                        
                        <button @click="forceReset" 
                                class="text-xs px-3 py-1.5 bg-red-500 text-white rounded hover:bg-red-600">
                            <i class="fas fa-power-off mr-1"></i>
                            Force Reset System
                        </button>
                        
                        <button @click="checkSystemStatus" 
                                class="text-xs px-3 py-1.5 bg-green-500 text-white rounded hover:bg-green-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            Check Status
                        </button>
                    </div>
                </div>

                <!-- รายการงาน -->
                <div class="border rounded-lg">
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg font-medium">รายการงานทั้งหมด</h2>
                            <div class="flex items-center gap-4">
                                <button v-if="completedTasksCount > 0"
                                        @click="deleteAllCompletedTasks"
                                        class="text-xs px-3 py-1.5 border border-red-200 text-red-600 rounded hover:bg-red-50"
                                        :disabled="deletingAllCompleted">
                                    <i class="fas mr-1" 
                                       :class="deletingAllCompleted ? 'fa-spin fa-spinner' : 'fa-trash'"></i>
                                    {{ deletingAllCompleted ? 'กำลังลบ...' : `ลบงานที่เสร็จแล้ว (${completedTasksCount})` }}
                                </button>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-sync-alt mr-1"></i>อัพเดทอัตโนมัติทุก 5 วินาที
                                </div>
                            </div>
                        </div>
                        
                        <!-- แสดง Loading -->
                        <div v-if="loading" class="space-y-3">
                            <div v-for="n in 3" :key="n" class="animate-pulse">
                                <div class="h-16 bg-gray-50 rounded-md"></div>
                            </div>
                        </div>
                        
                        <!-- แสดงรายการงาน -->
                        <div v-else class="space-y-3">
                            <!-- แสดงข้อความเมื่อไม่มีงาน -->
                            <div v-if="tasks.length === 0" class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-4 text-gray-300"></i>
                                <p class="text-lg">ยังไม่มีงานในระบบ</p>
                                <p class="text-sm">งานที่ส่งมาจะแสดงที่นี่</p>
                            </div>
                            
                            <!-- แสดงรายการงาน -->
                            <div v-for="task in tasks" :key="task.taskId" 
                                 class="task-card border rounded-md p-4"
                                 :class="getStatusColor(task.status)">
                                
                                <div class="flex justify-between items-center">
                                    <div>
                                        <div class="flex items-center gap-2 mb-2">
                                            <i :class="getStatusIcon(task.status)" 
                                               class="text-base"
                                               :class="getStatusIconColor(task.status)"></i>
                                            <span class="text-sm font-medium">{{ task.taskId }}</span>
                                        </div>
                                        
                                        <div class="space-y-1 text-xs text-gray-500">
                                            <p>
                                                <i :class="getJobTypeIcon(task.type)" class="mr-1"></i>
                                                ประเภทงาน: {{ getJobType(task.type) }}
                                            </p>
                                            <p v-if="task.type !== 'stream'">คุณภาพ: {{ task.quality }}</p>
                                            <p>สร้างเมื่อ: {{ formatDate(task.createdAt) }}</p>
                                            <p>สถานะ: {{ getStatusText(task.status) }}</p>
                                            <p v-if="task.inputFileSizeFormatted">ขนาดต้นฉบับ: {{ task.inputFileSizeFormatted }}</p>
                                            <p v-if="task.outputFileSizeFormatted && task.status === 'completed'">ขนาดหลังแปลง: {{ task.outputFileSizeFormatted }}</p>
                                                                                        <p v-if="task.compressionRatio && task.status === 'completed'" 
                                               :class="task.compressionRatio > 0 ? 'text-green-600' : 'text-orange-600'">
                                               {{ task.compressionRatio > 0 ? `ลดขนาด: ${task.compressionRatio}%` : 'ขนาดเพิ่มขึ้น' }}
                                            </p>
                                            <p v-if="task.type === 'stream' && task.cloudflareStreamId">
                                                <i class="fas fa-id-card mr-1"></i>
                                                Stream ID: {{ task.cloudflareStreamId }}
                                            </p>
                                            <p v-if="task.type === 'stream' && task.cloudflareStreamStatus">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                CF Status: {{ task.cloudflareStreamStatus }}
                                            </p>
                                        </div>
                                            <!-- Cloudflare Stream specific info -->
                                            <div v-if="task.type === 'stream' && task.streamData">
                                                <p v-if="task.streamData.uid" class="text-blue-600">
                                                    <i class="fas fa-video mr-1"></i>Stream UID: {{ task.streamData.uid }}
                                                </p>
                                                <p v-if="task.streamData.duration" class="text-gray-600">
                                                    <i class="fas fa-clock mr-1"></i>ระยะเวลา: {{ Math.round(task.streamData.duration) }} วินาที
                                                </p>
                                                <p v-if="task.streamData.size" class="text-gray-600">
                                                    <i class="fas fa-file-video mr-1"></i>ขนาดไฟล์: {{ formatFileSize(task.streamData.size) }}
                                                </p>
                                                <p v-if="task.streamData.readyToStream !== undefined" 
                                                   :class="task.streamData.readyToStream ? 'text-green-600' : 'text-yellow-600'">
                                                    <i :class="task.streamData.readyToStream ? 'fas fa-check-circle' : 'fas fa-clock'" class="mr-1"></i>
                                                    {{ task.streamData.readyToStream ? 'พร้อมสตรีม' : 'กำลังประมวลผล' }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center gap-4">
                                        <div v-if="task.status === 'processing'" class="text-right">
                                            <div class="w-32 bg-gray-100 rounded-full h-1.5">
                                                <div class="bg-blue-500 h-1.5 rounded-full transition-all" 
                                                     :style="{ width: task.percent + '%' }"></div>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">{{ task.percent }}%</p>
                                        </div>
                                        
                                        <button v-if="task.status === 'processing'"
                                                @click="stopTask(task.taskId)"
                                                class="text-xs px-3 py-1.5 border border-red-200 text-red-600 rounded hover:bg-red-50">
                                            <i class="fas fa-stop mr-1"></i>หยุด
                                        </button>
                                        
                                        <!-- Cloudflare Stream links -->
                                        <div v-if="task.type === 'stream' && task.status === 'completed' && task.streamData" class="flex gap-2">
                                            <a v-if="task.streamData.preview" 
                                               :href="task.streamData.preview"
                                               target="_blank"
                                               class="text-xs px-3 py-1.5 border border-blue-200 text-blue-600 rounded hover:bg-blue-50">
                                                <i class="fas fa-play mr-1"></i>ดูสตรีม
                                            </a>
                                            <a v-if="task.streamData.thumbnail" 
                                               :href="task.streamData.thumbnail"
                                               target="_blank"
                                               class="text-xs px-3 py-1.5 border border-green-200 text-green-600 rounded hover:bg-green-50">
                                                <i class="fas fa-image mr-1"></i>Thumbnail
                                            </a>
                                        </div>
                                        
                                        <!-- Regular download for convert tasks -->
                                        <a v-if="task.type !== 'stream' && task.status === 'completed'" 
                                           :href="'/outputs/' + task.taskId + '-output.mp4'"
                                           class="text-xs px-3 py-1.5 border border-green-200 text-green-600 rounded hover:bg-green-50">
                                            <i class="fas fa-download mr-1"></i>ดาวน์โหลด
                                        </a>
                                        
                                        <button v-if="['completed', 'error', 'stopped'].includes(task.status)"
                                                @click="deleteTask(task.taskId)"
                                                class="text-xs px-3 py-1.5 border border-red-200 text-red-600 rounded hover:bg-red-50"
                                                :disabled="deletingTasks[task.taskId]">
                                            <i class="fas fa-trash mr-1" 
                                               :class="deletingTasks[task.taskId] ? 'fa-spin fa-spinner' : 'fa-trash'"></i>
                                            {{ deletingTasks[task.taskId] ? 'กำลังลบ...' : 'ลบ' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-8 border-t pt-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Server Details -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">รายละเอียดเซิร์ฟเวอร์</h3>
                            <div class="space-y-2 text-xs text-gray-600">
                                <p><span class="font-medium">Web Framework:</span> {{ serverInfo.server.framework }}</p>
                                <p><span class="font-medium">Server Port:</span> {{ serverInfo.server.port }}</p>
                                <p><span class="font-medium">Base URL:</span> {{ serverInfo.server.baseUrl }}</p>
                                <p><span class="font-medium">Storage:</span> {{ serverInfo.server.storage.database }} + {{ serverInfo.server.storage.fileStorage }}</p>
                                <p><span class="font-medium">Middleware:</span> {{ serverInfo.server.middleware.join(', ') }}</p>
                            </div>
                        </div>

                        <!-- FFmpeg Details -->
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-3">รายละเอียด FFmpeg</h3>
                            <div class="space-y-2 text-xs text-gray-600">
                                <p><span class="font-medium">Library:</span> {{ serverInfo.ffmpeg.library }}</p>
                                <p><span class="font-medium">Version:</span> {{ serverInfo.ffmpeg.version }}</p>
                                <p><span class="font-medium">Video Codec:</span> {{ serverInfo.ffmpeg.videoCodec }}</p>
                                <p><span class="font-medium">Preset:</span> {{ serverInfo.ffmpeg.preset }}</p>
                                <p><span class="font-medium">CRF Value:</span> {{ serverInfo.ffmpeg.crfValue }}</p>
                                <p><span class="font-medium">รองรับความละเอียด:</span> {{ serverInfo.ffmpeg.supportedResolutions.join(', ') }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-center text-xs text-gray-500">
                        <p>© {{ new Date().getFullYear() }} Video Transcoding Service. All rights reserved.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue

        const app = createApp({
            data() {
                return {
                    tasks: [],
                    refreshInterval: null,
                    deletingTasks: {}, // Track which tasks are being deleted
                    deletingAllCompleted: false, // Track bulk delete operation
                    stats: {
                        total: 0,
                        processing: 0,
                        completed: 0,
                        error: 0,
                        totalSaved: 'N/A',
                        compressionRatio: '0'
                    },
                    loading: true,
                    showNotification: false,
                    notificationMessage: '',
                    apiErrors: {
                        tasks: false,
                        systemMetrics: false,
                        systemStatus: false,
                        serverInfo: false
                    },
                    systemMetrics: {
                        cpu: { usage: 0, cores: 0 },
                        memory: { total: 0, used: 0, free: 0, usagePercent: 0 },
                        disk: { total: 0, used: 0, free: 0, usagePercent: 0 }
                    },
                    systemStatus: {
                        system: {
                            concurrentJobs: 0,
                            maxConcurrentJobs: 0,
                            activeProcesses: 0
                        },
                        tasks: {
                            total: 0,
                            queued: 0,
                            processing: 0,
                            completed: 0,
                            error: 0
                        }
                    },
                    metricsInterval: null,
                    statusInterval: null,
                    serverInfo: {
                        server: {
                            framework: '',
                            port: '',
                            baseUrl: '',
                            storage: { database: '', fileStorage: '' },
                            middleware: []
                        },
                        ffmpeg: {
                            library: '',
                            version: '',
                            videoCodec: '',
                            preset: '',
                            crfValue: '',
                            supportedResolutions: []
                        }
                    }
                }
            },

            computed: {
                completedTasks() {
                    return this.tasks.filter(task => task.status === 'completed')
                },
                completedTasksCount() {
                    return this.completedTasks.length
                },
                hasCompletedTasks() {
                    return this.completedTasksCount > 0
                }
            },

            mounted() {
                this.fetchTasks()
                this.refreshInterval = setInterval(this.fetchTasks, 5000)
                this.fetchSystemMetrics()
                this.metricsInterval = setInterval(this.fetchSystemMetrics, 2000)
                this.fetchSystemStatus()
                this.statusInterval = setInterval(this.fetchSystemStatus, 5000)
                this.fetchServerInfo()
            },

            beforeUnmount() {
                clearInterval(this.refreshInterval)
                clearInterval(this.metricsInterval)
                clearInterval(this.statusInterval)
            },

            methods: {
                async fetchTasks() {
                    try {
                        console.log('Fetching tasks...'); // Debug log
                        const response = await fetch('/tasks')
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json()
                        console.log('Tasks response:', data); // Debug log
                        
                        if (data.success) {
                            this.tasks = data.tasks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                            console.log('Tasks loaded:', this.tasks.length); // Debug log
                            this.apiErrors.tasks = false
                        } else {
                            console.error('Failed to fetch tasks:', data.error);
                            this.apiErrors.tasks = true
                        }
                        
                        this.updateStats()
                        this.loading = false
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error)
                        this.apiErrors.tasks = true
                        this.showNotification = true
                        this.notificationMessage = `เกิดข้อผิดพลาดในการดึงข้อมูลงาน: ${error.message}`
                        setTimeout(() => this.showNotification = false, 5000)
                        this.loading = false
                    }
                },

                updateStats() {
                    const completedTasks = this.tasks.filter(t => t.status === 'completed');
                    
                    // คำนวณขนาดไฟล์ที่ประหยัดได้
                    let totalInputSize = 0;
                    let totalOutputSize = 0;
                    let validCompressions = 0;
                    
                    completedTasks.forEach(task => {
                        if (task.inputFileSize && task.outputFileSize) {
                            totalInputSize += task.inputFileSize;
                            totalOutputSize += task.outputFileSize;
                            validCompressions++;
                        }
                    });
                    
                    const totalSaved = totalInputSize - totalOutputSize;
                    const compressionRatio = totalInputSize > 0 ? ((totalSaved / totalInputSize) * 100) : 0;
                    
                    this.stats = {
                        total: this.tasks.length,
                        processing: this.tasks.filter(t => t.status === 'processing').length,
                        completed: completedTasks.length,
                        error: this.tasks.filter(t => t.status === 'error').length,
                        totalSaved: this.formatFileSize(totalSaved),
                        compressionRatio: compressionRatio > 0 ? compressionRatio.toFixed(1) : '0'
                    }
                },

                async stopTask(taskId) {
                    try {
                        await fetch(`/stop/${taskId}`, { method: 'POST' })
                        this.showNotification = true
                        this.notificationMessage = 'หยุดการประมวลผลเรียบร้อย'
                        setTimeout(() => this.showNotification = false, 3000)
                        this.fetchTasks()
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการหยุดงาน:', error)
                    }
                },

                async deleteTask(taskId) {
                    // Confirm deletion
                    if (!confirm('คุณแน่ใจหรือไม่ที่จะลบงานนี้? ไฟล์ทั้งหมดจะถูกลบถาวร')) {
                        return;
                    }

                    // Set loading state
                    this.deletingTasks[taskId] = true;
                    
                    try {
                        const response = await fetch(`/task/${taskId}`, { 
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            this.showNotification = true;
                            this.notificationMessage = 'ลบงานเรียบร้อยแล้ว';
                            setTimeout(() => this.showNotification = false, 3000);
                            
                            // Remove task from local list immediately
                            this.tasks = this.tasks.filter(task => task.taskId !== taskId);
                            
                            // Refresh tasks to ensure consistency
                            this.fetchTasks();
                        } else {
                            throw new Error(data.error || 'Failed to delete task');
                        }
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการลบงาน:', error);
                        this.showNotification = true;
                        this.notificationMessage = 'เกิดข้อผิดพลาดในการลบงาน: ' + error.message;
                        setTimeout(() => this.showNotification = false, 5000);
                    } finally {
                        // Clear loading state
                        delete this.deletingTasks[taskId];
                    }
                },

                async deleteAllCompletedTasks() {
                    // Confirm bulk deletion
                    if (!confirm(`คุณแน่ใจหรือไม่ที่จะลบงานที่เสร็จแล้วทั้งหมด ${this.completedTasksCount} งาน? ไฟล์ทั้งหมดจะถูกลบถาวร`)) {
                        return;
                    }

                    // Set loading state
                    this.deletingAllCompleted = true;
                    
                    try {
                        let successCount = 0;
                        let errorCount = 0;
                        
                        // Delete each completed task
                        for (const task of this.completedTasks) {
                            try {
                                const response = await fetch(`/task/${task.taskId}`, { 
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });
                                
                                const data = await response.json();
                                
                                if (response.ok && data.success) {
                                    successCount++;
                                    // Remove task from local list immediately
                                    this.tasks = this.tasks.filter(t => t.taskId !== task.taskId);
                                } else {
                                    errorCount++;
                                    console.error('Failed to delete task:', task.taskId, data.error);
                                }
                            } catch (error) {
                                errorCount++;
                                console.error('Error deleting task:', task.taskId, error);
                            }
                        }
                        
                        // Show result notification
                        if (successCount > 0) {
                            this.showNotification = true;
                            this.notificationMessage = `ลบงานเรียบร้อยแล้ว ${successCount} งาน${errorCount > 0 ? ` (ผิดพลาด ${errorCount} งาน)` : ''}`;
                            setTimeout(() => this.showNotification = false, 4000);
                        }
                        
                        if (errorCount > 0 && successCount === 0) {
                            this.showNotification = true;
                            this.notificationMessage = `เกิดข้อผิดพลาดในการลบงาน ${errorCount} งาน`;
                            setTimeout(() => this.showNotification = false, 5000);
                        }
                        
                        // Refresh tasks to ensure consistency
                        this.fetchTasks();
                        
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการลบงานทั้งหมด:', error);
                        this.showNotification = true;
                        this.notificationMessage = 'เกิดข้อผิดพลาดในการลบงานทั้งหมด: ' + error.message;
                        setTimeout(() => this.showNotification = false, 5000);
                    } finally {
                        // Clear loading state
                        this.deletingAllCompleted = false;
                    }
                },

                getStatusColor(status) {
                    const colors = {
                        'queued': 'bg-gray-50',
                        'processing': 'bg-blue-50',
                        'completed': 'bg-green-50',
                        'error': 'bg-red-50',
                        'stopped': 'bg-gray-50'
                    }
                    return colors[status] || 'bg-gray-50'
                },

                getStatusIcon(status) {
                    const icons = {
                        'queued': 'fas fa-clock',
                        'processing': 'fas fa-spinner fa-spin',
                        'completed': 'fas fa-check-circle',
                        'error': 'fas fa-exclamation-circle',
                        'stopped': 'fas fa-stop-circle'
                    }
                    return icons[status] || 'fas fa-question-circle'
                },

                getStatusText(status) {
                    const texts = {
                        'queued': 'รอดำเนินการ',
                        'processing': 'กำลังประมวลผล',
                        'completed': 'เสร็จสมบูรณ์',
                        'error': 'เกิดข้อผิดพลาด',
                        'stopped': 'หยุดการทำงาน'
                    }
                    return texts[status] || status
                },

                getJobType(type) {
                    const types = {
                        'convert': 'แปลงวิดีโอ',
                        'trim': 'ตัดต่อวิดีโอ',
                        'stream': 'อัปโหลด Cloudflare Stream'
                    }
                    return types[type] || 'แปลงวิดีโอ' // Default to convert if type is undefined
                },

                getJobTypeIcon(type) {
                    const icons = {
                        'convert': 'fas fa-exchange-alt',
                        'trim': 'fas fa-cut',
                        'stream': 'fas fa-cloud-upload-alt'
                    }
                    return icons[type] || 'fas fa-exchange-alt' // Default to convert icon
                },

                formatDate(date) {
                    return new Date(date).toLocaleString('th-TH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                },

                formatFileSize(bytes) {
                    if (!bytes || bytes === 0) return 'N/A';
                    
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    
                    if (i === 0) return `${bytes} ${sizes[i]}`;
                    return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${sizes[i]}`;
                },

                getStatusIconColor(status) {
                    const colors = {
                        'queued': 'text-gray-400',
                        'processing': 'text-blue-500',
                        'completed': 'text-green-500',
                        'error': 'text-red-500',
                        'stopped': 'text-gray-400'
                    }
                    return colors[status] || 'text-gray-400'
                },

                async fetchSystemMetrics() {
                    try {
                        console.log('Fetching system metrics...'); // Debug log
                        const response = await fetch('/system-metrics')
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json()
                        console.log('System metrics response:', data); // Debug log
                        this.systemMetrics = data
                        this.apiErrors.systemMetrics = false
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลระบบ:', error)
                        this.apiErrors.systemMetrics = true
                    }
                },

                async fetchServerInfo() {
                    try {
                        const response = await fetch('/server-info')
                        const data = await response.json()
                        this.serverInfo = data
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการดึงข้อมูลเซิร์ฟเวอร์:', error)
                    }
                },

                async fetchSystemStatus() {
                    try {
                        console.log('Fetching system status...'); // Debug log
                        const response = await fetch('/system-status')
                        const data = await response.json()
                        console.log('System status response:', data); // Debug log
                        if (data.success) {
                            this.systemStatus = data
                        } else {
                            console.error('Failed to fetch system status:', data.error);
                        }
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการดึงสถานะระบบ:', error)
                    }
                },

                async retryFailedTasks() {
                    try {
                        const response = await fetch('/retry-failed', { method: 'POST' })
                        const data = await response.json()
                        if (data.success) {
                            this.showNotification = true
                            this.notificationMessage = data.message
                            setTimeout(() => this.showNotification = false, 5000)
                            this.fetchTasks()
                            this.fetchSystemStatus()
                        }
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการ retry งาน:', error)
                        this.showNotification = true
                        this.notificationMessage = 'เกิดข้อผิดพลาดในการ retry งาน'
                        setTimeout(() => this.showNotification = false, 3000)
                    }
                },

                async cleanupOldTasks() {
                    try {
                        const response = await fetch('/cleanup-old-tasks', { method: 'DELETE' })
                        const data = await response.json()
                        if (data.success) {
                            this.showNotification = true
                            this.notificationMessage = data.message
                            setTimeout(() => this.showNotification = false, 5000)
                            this.fetchTasks()
                            this.fetchSystemStatus()
                        }
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการ cleanup งาน:', error)
                        this.showNotification = true
                        this.notificationMessage = 'เกิดข้อผิดพลาดในการ cleanup งาน'
                        setTimeout(() => this.showNotification = false, 3000)
                    }
                },
                
                async forceReset() {
                    if (!confirm('คุณแน่ใจหรือไม่ที่จะ Force Reset ระบบ? การกระทำนี้จะหยุดงานทั้งหมดและรีเซ็ตระบบ')) {
                        return
                    }
                    
                    try {
                        const response = await fetch('/force-reset', { method: 'POST' })
                        const data = await response.json()
                        if (data.success) {
                            this.showNotification = true
                            this.notificationMessage = `Reset สำเร็จ: หยุด ${data.resetProcesses} processes และ reset ${data.resetTasks} tasks`
                            setTimeout(() => this.showNotification = false, 5000)
                            this.fetchTasks()
                            this.fetchSystemStatus()
                        } else {
                            throw new Error(data.error || 'Unknown error')
                        }
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการ Force Reset:', error)
                        this.showNotification = true
                        this.notificationMessage = 'เกิดข้อผิดพลาดในการ Force Reset: ' + error.message
                        setTimeout(() => this.showNotification = false, 5000)
                    }
                },
                
                async checkSystemStatus() {
                    try {
                        const response = await fetch('/system-status')
                        const data = await response.json()
                        if (data.success) {
                            console.log('System Status:', data.status)
                            this.showNotification = true
                            this.notificationMessage = `System Status: 
                                Concurrent Jobs: ${data.status.concurrentJobs}/${data.status.maxConcurrentJobs}
                                Running Processes: ${data.status.runningProcesses.length}
                                Queued Tasks: ${data.status.taskCounts.queued}
                                Processing Tasks: ${data.status.taskCounts.processing}
                                CPU: ${data.status.systemLoad.cpuUsage}%, Memory: ${data.status.systemLoad.memoryUsage}%`
                            setTimeout(() => this.showNotification = false, 8000)
                        } else {
                            throw new Error(data.error || 'Unknown error')
                        }
                    } catch (error) {
                        console.error('เกิดข้อผิดพลาดในการตรวจสอบสถานะ:', error)
                        this.showNotification = true
                        this.notificationMessage = 'เกิดข้อผิดพลาดในการตรวจสอบสถานะ: ' + error.message
                        setTimeout(() => this.showNotification = false, 5000)
                    }
                },

                copyStreamId(streamId) {
                    navigator.clipboard.writeText(streamId).then(() => {
                        this.showNotification = true
                        this.notificationMessage = `คัดลอก Stream ID แล้ว: ${streamId}`
                        setTimeout(() => this.showNotification = false, 3000)
                    }).catch(err => {
                        console.error('ไม่สามารถคัดลอกได้:', err)
                        this.showNotification = true
                        this.notificationMessage = 'ไม่สามารถคัดลอก Stream ID ได้'
                        setTimeout(() => this.showNotification = false, 3000)
                    })
                }
            }
        })

        app.mount('#app')
    </script>
</body>
</html> 